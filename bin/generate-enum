#!/usr/bin/env php
<?php

/**
 * Script de maintenance pour gÃ©nÃ©rer l'Enum DaplosReferentialType.
 * 
 * Ce script interroge l'API DAPLOS pour rÃ©cupÃ©rer tous les rÃ©fÃ©rentiels disponibles
 * et gÃ©nÃ¨re automatiquement l'Enum PHP correspondant dans src/Enum/.
 * 
 * âš ï¸ USAGE INTERNE UNIQUEMENT
 * Ce script est destinÃ© aux mainteneurs du bundle uniquement.
 * Les utilisateurs finaux du bundle ne doivent PAS l'utiliser.
 * 
 * Usage:
 *   php bin/generate-enum
 *   php bin/generate-enum --dry-run
 *   php bin/generate-enum --exclude-ids=123,456
 *   php bin/generate-enum --exclude-file=/path/to/excluded-referentials.json
 * 
 * Exclusion de rÃ©fÃ©rentiels:
 *   Les rÃ©fÃ©rentiels abandonnÃ©s peuvent Ãªtre exclus via le fichier .excluded-referentials.json
 *   Ã  la racine du projet. Format JSON avec deux clÃ©s optionnelles:
 *   - "ids": [123, 456] - Liste des IDs de rÃ©fÃ©rentiels Ã  exclure
 *   - "names": ["Nom du rÃ©fÃ©rentiel"] - Liste des noms de rÃ©fÃ©rentiels Ã  exclure
 * 
 * @author Yoan Bernabeu
 * @internal
 */

declare(strict_types=1);

// Bootstrap
require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Console\Helper\ProgressBar;

// Configuration
$config = [
    'api_url' => getenv('DAPLOS_API_URL') ?: 'https://agroedieurope.fr/wp-json/hwc/v1',
    'api_login' => getenv('DAPLOS_API_LOGIN') ?: '',
    'api_key' => getenv('DAPLOS_API_KEY') ?: '',
];

$outputDir = null;
$dryRun = false;
$excludeFile = null;
$excludeIds = [];

// Parse arguments
foreach ($argv as $arg) {
    if ($arg === '--dry-run') {
        $dryRun = true;
    } elseif (str_starts_with($arg, '--output-dir=')) {
        $outputDir = substr($arg, strlen('--output-dir='));
    } elseif (str_starts_with($arg, '--exclude-file=')) {
        $excludeFile = substr($arg, strlen('--exclude-file='));
    } elseif (str_starts_with($arg, '--exclude-ids=')) {
        $excludeIds = array_map('intval', explode(',', substr($arg, strlen('--exclude-ids='))));
    }
}

// Charger les IDs exclus depuis le fichier si spÃ©cifiÃ© ou depuis le fichier par dÃ©faut
$defaultExcludeFile = __DIR__ . '/../.excluded-referentials.json';
if ($excludeFile === null && file_exists($defaultExcludeFile)) {
    $excludeFile = $defaultExcludeFile;
}

if ($excludeFile !== null && file_exists($excludeFile)) {
    $excludedData = json_decode(file_get_contents($excludeFile), true);
    if (is_array($excludedData)) {
        if (isset($excludedData['ids']) && is_array($excludedData['ids'])) {
            $excludeIds = array_merge($excludeIds, array_map('intval', $excludedData['ids']));
        }
    }
}

$excludeIds = array_unique($excludeIds);

$outputDir = $outputDir ?: __DIR__ . '/../src/Enum';

// Output
$output = new ConsoleOutput();
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln('<info>  ğŸ”§ DAPLOS Bundle - GÃ©nÃ©rateur d\'Enum (Maintenance)</info>');
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln('');

if ($dryRun) {
    $output->writeln('<comment>âš ï¸  Mode DRY-RUN : Aucun fichier ne sera crÃ©Ã©</comment>');
    $output->writeln('');
}

if (!empty($excludeIds)) {
    $output->writeln(sprintf('<info>ğŸš« Exclusion de %d rÃ©fÃ©rentiel(s) par ID</info>', count($excludeIds)));
    if ($excludeFile !== null) {
        $output->writeln(sprintf('<info>   Fichier d\'exclusion : %s</info>', $excludeFile));
    }
    $output->writeln('');
}

// VÃ©rifier les credentials
if (empty($config['api_login']) || empty($config['api_key'])) {
    $output->writeln('<error>âŒ Erreur : Credentials API manquants</error>');
    $output->writeln('');
    $output->writeln('DÃ©finissez les variables d\'environnement :');
    $output->writeln('  export DAPLOS_API_LOGIN="votre_login"');
    $output->writeln('  export DAPLOS_API_KEY="votre_cle"');
    $output->writeln('');
    exit(1);
}

// RÃ©cupÃ©rer les rÃ©fÃ©rentiels
$output->writeln('ğŸ“¡ RÃ©cupÃ©ration des rÃ©fÃ©rentiels depuis l\'API DAPLOS...');
$url = sprintf(
    '%s/referencials/?login=%s&apikey=%s',
    rtrim($config['api_url'], '/'),
    urlencode($config['api_login']),
    urlencode($config['api_key'])
);

$response = @file_get_contents($url);

if ($response === false) {
    $output->writeln('<error>âŒ Erreur : Impossible de contacter l\'API DAPLOS</error>');
    exit(1);
}

$referentials = json_decode($response, true);

if (!is_array($referentials) || empty($referentials)) {
    $output->writeln('<error>âŒ Erreur : Aucun rÃ©fÃ©rentiel trouvÃ©</error>');
    exit(1);
}

$output->writeln(sprintf('<info>âœ… %d rÃ©fÃ©rentiels trouvÃ©s</info>', count($referentials)));

// Filtrer les rÃ©fÃ©rentiels exclus
$excludedData = null;
if ($excludeFile !== null && file_exists($excludeFile)) {
    $excludedData = json_decode(file_get_contents($excludeFile), true);
}

$originalCount = count($referentials);
$referentials = array_filter($referentials, function ($ref) use ($excludeIds, $excludedData) {
    // Exclure par ID
    if (in_array((int) $ref['id'], $excludeIds, true)) {
        return false;
    }

    // Exclure par nom si spÃ©cifiÃ© dans le fichier
    if (is_array($excludedData) && isset($excludedData['names']) && is_array($excludedData['names'])) {
        if (in_array($ref['name'], $excludedData['names'], true)) {
            return false;
        }
    }

    return true;
});

$excludedCount = $originalCount - count($referentials);
if ($excludedCount > 0) {
    $output->writeln(sprintf('<comment>â­ï¸  %d rÃ©fÃ©rentiel(s) exclu(s)</comment>', $excludedCount));
}

$output->writeln(sprintf('<info>ğŸ“¦ %d rÃ©fÃ©rentiel(s) Ã  inclure dans l\'Enum</info>', count($referentials)));
$output->writeln('');

// CrÃ©er le rÃ©pertoire si nÃ©cessaire
if (!$dryRun && !is_dir($outputDir)) {
    mkdir($outputDir, 0755, true);
    $output->writeln(sprintf('<info>ğŸ“ RÃ©pertoire crÃ©Ã© : %s</info>', $outputDir));
}

// Fonctions helper
/**
 * Convertit une chaÃ®ne en SCREAMING_SNAKE_CASE pour les cases d'enum.
 */
function toEnumCase(string $text): string
{
    // Nettoyer les accents
    $unwantedArray = [
        'Å ' => 'S', 'Å¡' => 's', 'Å½' => 'Z', 'Å¾' => 'z',
        'Ã€' => 'A', 'Ã' => 'A', 'Ã‚' => 'A', 'Ãƒ' => 'A', 'Ã„' => 'A', 'Ã…' => 'A', 'Ã†' => 'A',
        'Ã‡' => 'C', 'Ãˆ' => 'E', 'Ã‰' => 'E', 'ÃŠ' => 'E', 'Ã‹' => 'E',
        'ÃŒ' => 'I', 'Ã' => 'I', 'Ã' => 'I', 'Ã' => 'I', 'Ã‘' => 'N',
        'Ã’' => 'O', 'Ã“' => 'O', 'Ã”' => 'O', 'Ã•' => 'O', 'Ã–' => 'O', 'Ã˜' => 'O',
        'Ã™' => 'U', 'Ãš' => 'U', 'Ã›' => 'U', 'Ãœ' => 'U', 'Ã' => 'Y', 'Ã' => 'B', 'ÃŸ' => 'Ss',
        'Ã ' => 'a', 'Ã¡' => 'a', 'Ã¢' => 'a', 'Ã£' => 'a', 'Ã¤' => 'a', 'Ã¥' => 'a', 'Ã¦' => 'a',
        'Ã§' => 'c', 'Ã¨' => 'e', 'Ã©' => 'e', 'Ãª' => 'e', 'Ã«' => 'e',
        'Ã¬' => 'i', 'Ã­' => 'i', 'Ã®' => 'i', 'Ã¯' => 'i', 'Ã°' => 'o', 'Ã±' => 'n',
        'Ã²' => 'o', 'Ã³' => 'o', 'Ã´' => 'o', 'Ãµ' => 'o', 'Ã¶' => 'o', 'Ã¸' => 'o',
        'Ã¹' => 'u', 'Ãº' => 'u', 'Ã»' => 'u', 'Ã¼' => 'u', 'Ã½' => 'y', 'Ã¾' => 'b', 'Ã¿' => 'y'
    ];

    $text = strtr($text, $unwantedArray);

    // Remplacer les caractÃ¨res non alphanumÃ©riques par des underscores
    $text = preg_replace('/[^a-zA-Z0-9]+/', '_', $text);
    
    // Convertir en majuscules
    $text = strtoupper($text);
    
    // Supprimer les underscores en dÃ©but/fin
    $text = trim($text, '_');
    
    // Ã‰viter les underscores multiples
    $text = preg_replace('/_+/', '_', $text);

    return $text;
}

/**
 * Convertit une chaÃ®ne en snake_case pour la valeur de l'enum.
 */
function toSnakeCase(string $text): string
{
    // Nettoyer les accents
    $unwantedArray = [
        'Å ' => 'S', 'Å¡' => 's', 'Å½' => 'Z', 'Å¾' => 'z',
        'Ã€' => 'A', 'Ã' => 'A', 'Ã‚' => 'A', 'Ãƒ' => 'A', 'Ã„' => 'A', 'Ã…' => 'A', 'Ã†' => 'A',
        'Ã‡' => 'C', 'Ãˆ' => 'E', 'Ã‰' => 'E', 'ÃŠ' => 'E', 'Ã‹' => 'E',
        'ÃŒ' => 'I', 'Ã' => 'I', 'Ã' => 'I', 'Ã' => 'I', 'Ã‘' => 'N',
        'Ã’' => 'O', 'Ã“' => 'O', 'Ã”' => 'O', 'Ã•' => 'O', 'Ã–' => 'O', 'Ã˜' => 'O',
        'Ã™' => 'U', 'Ãš' => 'U', 'Ã›' => 'U', 'Ãœ' => 'U', 'Ã' => 'Y', 'Ã' => 'B', 'ÃŸ' => 'Ss',
        'Ã ' => 'a', 'Ã¡' => 'a', 'Ã¢' => 'a', 'Ã£' => 'a', 'Ã¤' => 'a', 'Ã¥' => 'a', 'Ã¦' => 'a',
        'Ã§' => 'c', 'Ã¨' => 'e', 'Ã©' => 'e', 'Ãª' => 'e', 'Ã«' => 'e',
        'Ã¬' => 'i', 'Ã­' => 'i', 'Ã®' => 'i', 'Ã¯' => 'i', 'Ã°' => 'o', 'Ã±' => 'n',
        'Ã²' => 'o', 'Ã³' => 'o', 'Ã´' => 'o', 'Ãµ' => 'o', 'Ã¶' => 'o', 'Ã¸' => 'o',
        'Ã¹' => 'u', 'Ãº' => 'u', 'Ã»' => 'u', 'Ã¼' => 'u', 'Ã½' => 'y', 'Ã¾' => 'b', 'Ã¿' => 'y'
    ];

    $text = strtr($text, $unwantedArray);

    // Remplacer les caractÃ¨res non alphanumÃ©riques par des underscores
    $text = preg_replace('/[^a-zA-Z0-9]+/', '_', $text);
    
    // Convertir en minuscules
    $text = strtolower($text);
    
    // Supprimer les underscores en dÃ©but/fin
    $text = trim($text, '_');
    
    // Ã‰viter les underscores multiples
    $text = preg_replace('/_+/', '_', $text);

    return $text;
}

/**
 * GÃ©nÃ¨re le contenu de l'Enum.
 */
function generateEnumContent(array $referentials): string
{
    $cases = [];
    $idMapping = [];
    $labelMapping = [];
    $repoCodeMapping = [];

    foreach ($referentials as $ref) {
        $caseName = toEnumCase($ref['name']);
        $caseValue = toSnakeCase($ref['name']);
        
        $cases[] = sprintf("    case %s = '%s';", $caseName, $caseValue);
        $idMapping[] = sprintf("            self::%s => %d,", $caseName, $ref['id']);
        $labelMapping[] = sprintf("            self::%s => '%s',", $caseName, addslashes($ref['name']));
        $repoCodeMapping[] = sprintf("            self::%s => '%s',", $caseName, addslashes($ref['repository_code']));
    }

    $casesStr = implode("\n", $cases);
    $idMappingStr = implode("\n", $idMapping);
    $labelMappingStr = implode("\n", $labelMapping);
    $repoCodeMappingStr = implode("\n", $repoCodeMapping);

    return <<<PHPCODE
<?php

declare(strict_types=1);

namespace YoanBernabeu\DaplosBundle\Enum;

/**
 * Enum reprÃ©sentant tous les types de rÃ©fÃ©rentiels DAPLOS disponibles.
 *
 * Cette enum est gÃ©nÃ©rÃ©e automatiquement par le script bin/generate-enum.
 * Ne pas modifier manuellement - utiliser le script pour rÃ©gÃ©nÃ©rer.
 *
 * @author Yoan Bernabeu
 */
enum DaplosReferentialType: string
{
{$casesStr}

    /**
     * Retourne l'ID du rÃ©fÃ©rentiel dans l'API DAPLOS.
     */
    public function getId(): int
    {
        return match (\$this) {
{$idMappingStr}
        };
    }

    /**
     * Retourne le libellÃ© lisible du rÃ©fÃ©rentiel.
     */
    public function getLabel(): string
    {
        return match (\$this) {
{$labelMappingStr}
        };
    }

    /**
     * Retourne le code du repository dans l'API DAPLOS.
     */
    public function getRepositoryCode(): string
    {
        return match (\$this) {
{$repoCodeMappingStr}
        };
    }

    /**
     * Trouve un type de rÃ©fÃ©rentiel par son ID API.
     */
    public static function fromId(int \$id): ?self
    {
        foreach (self::cases() as \$case) {
            if (\$case->getId() === \$id) {
                return \$case;
            }
        }

        return null;
    }

    /**
     * Trouve un type de rÃ©fÃ©rentiel par son code repository.
     */
    public static function fromRepositoryCode(string \$code): ?self
    {
        foreach (self::cases() as \$case) {
            if (\$case->getRepositoryCode() === \$code) {
                return \$case;
            }
        }

        return null;
    }
}

PHPCODE;
}

// GÃ©nÃ©rer l'Enum
$output->writeln('ğŸ”¨ GÃ©nÃ©ration de l\'Enum DaplosReferentialType...');

$enumContent = generateEnumContent($referentials);
$filePath = $outputDir . '/DaplosReferentialType.php';

if (!$dryRun) {
    file_put_contents($filePath, $enumContent);
    $output->writeln(sprintf('<info>âœ… Enum gÃ©nÃ©rÃ© : %s</info>', $filePath));
} else {
    $output->writeln('<comment>ğŸ“ [DRY-RUN] L\'Enum serait gÃ©nÃ©rÃ©</comment>');
}

// RÃ©sumÃ©
$output->writeln('');
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln(sprintf(
    '<info>  âœ… Enum %s avec %d rÃ©fÃ©rentiels</info>',
    $dryRun ? 'serait gÃ©nÃ©rÃ©' : 'gÃ©nÃ©rÃ©',
    count($referentials)
));
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln('');

if (!$dryRun) {
    $output->writeln('ğŸ“ Prochaines Ã©tapes :');
    $output->writeln('  1. VÃ©rifier l\'Enum gÃ©nÃ©rÃ©');
    $output->writeln('  2. Commit les changements : git add src/Enum/');
    $output->writeln('  3. git commit -m "RÃ©gÃ©nÃ©ration de l\'Enum DaplosReferentialType"');
}

$output->writeln('');
exit(0);

