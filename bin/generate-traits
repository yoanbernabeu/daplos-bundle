#!/usr/bin/env php
<?php

/**
 * Script de maintenance pour gÃ©nÃ©rer les traits DAPLOS.
 * 
 * Ce script interroge l'API DAPLOS pour rÃ©cupÃ©rer tous les rÃ©fÃ©rentiels disponibles
 * et gÃ©nÃ¨re automatiquement les traits PHP correspondants dans src/Entity/Trait/.
 * 
 * âš ï¸ USAGE INTERNE UNIQUEMENT
 * Ce script est destinÃ© aux mainteneurs du bundle uniquement.
 * Les utilisateurs finaux du bundle ne doivent PAS l'utiliser.
 * 
 * Usage:
 *   php bin/generate-traits
 *   php bin/generate-traits --dry-run
 *   php bin/generate-traits --output-dir=/custom/path
 *   php bin/generate-traits --exclude-ids=123,456
 *   php bin/generate-traits --exclude-file=/path/to/excluded-referentials.json
 * 
 * Exclusion de rÃ©fÃ©rentiels:
 *   Les rÃ©fÃ©rentiels abandonnÃ©s peuvent Ãªtre exclus via le fichier .excluded-referentials.json
 *   Ã  la racine du projet. Format JSON avec deux clÃ©s optionnelles:
 *   - "ids": [123, 456] - Liste des IDs de rÃ©fÃ©rentiels Ã  exclure
 *   - "names": ["Nom du rÃ©fÃ©rentiel"] - Liste des noms de rÃ©fÃ©rentiels Ã  exclure
 * 
 * @author Yoan Bernabeu
 * @internal
 */

declare(strict_types=1);

// Bootstrap
require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Console\Helper\ProgressBar;

// Configuration
$config = [
    'api_url' => getenv('DAPLOS_API_URL') ?: 'https://agroedieurope.fr/wp-json/hwc/v1',
    'api_login' => getenv('DAPLOS_API_LOGIN') ?: '',
    'api_key' => getenv('DAPLOS_API_KEY') ?: '',
];

$outputDir = null;
$dryRun = false;
$excludeFile = null;
$excludeIds = [];

// Parse arguments
foreach ($argv as $arg) {
    if ($arg === '--dry-run') {
        $dryRun = true;
    } elseif (str_starts_with($arg, '--output-dir=')) {
        $outputDir = substr($arg, strlen('--output-dir='));
    } elseif (str_starts_with($arg, '--exclude-file=')) {
        $excludeFile = substr($arg, strlen('--exclude-file='));
    } elseif (str_starts_with($arg, '--exclude-ids=')) {
        $excludeIds = array_map('intval', explode(',', substr($arg, strlen('--exclude-ids='))));
    }
}

// Charger les IDs exclus depuis le fichier si spÃ©cifiÃ© ou depuis le fichier par dÃ©faut
$defaultExcludeFile = __DIR__ . '/../.excluded-referentials.json';
if ($excludeFile === null && file_exists($defaultExcludeFile)) {
    $excludeFile = $defaultExcludeFile;
}

if ($excludeFile !== null && file_exists($excludeFile)) {
    $excludedData = json_decode(file_get_contents($excludeFile), true);
    if (is_array($excludedData)) {
        if (isset($excludedData['ids']) && is_array($excludedData['ids'])) {
            $excludeIds = array_merge($excludeIds, array_map('intval', $excludedData['ids']));
        }
        if (isset($excludedData['names']) && is_array($excludedData['names'])) {
            // Les noms seront filtrÃ©s plus tard
        }
    }
}

$excludeIds = array_unique($excludeIds);

$outputDir = $outputDir ?: __DIR__ . '/../src/Entity/Trait';

// Output
$output = new ConsoleOutput();
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln('<info>  ğŸ”§ DAPLOS Bundle - GÃ©nÃ©rateur de Traits (Maintenance)</info>');
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln('');

if ($dryRun) {
    $output->writeln('<comment>âš ï¸  Mode DRY-RUN : Aucun fichier ne sera crÃ©Ã©</comment>');
    $output->writeln('');
}

if (!empty($excludeIds)) {
    $output->writeln(sprintf('<info>ğŸš« Exclusion de %d rÃ©fÃ©rentiel(s) par ID</info>', count($excludeIds)));
    if ($excludeFile !== null) {
        $output->writeln(sprintf('<info>   Fichier d\'exclusion : %s</info>', $excludeFile));
    }
    $output->writeln('');
}

// VÃ©rifier les credentials
if (empty($config['api_login']) || empty($config['api_key'])) {
    $output->writeln('<error>âŒ Erreur : Credentials API manquants</error>');
    $output->writeln('');
    $output->writeln('DÃ©finissez les variables d\'environnement :');
    $output->writeln('  export DAPLOS_API_LOGIN="votre_login"');
    $output->writeln('  export DAPLOS_API_KEY="votre_cle"');
    $output->writeln('');
    exit(1);
}

// RÃ©cupÃ©rer les rÃ©fÃ©rentiels
$output->writeln('ğŸ“¡ RÃ©cupÃ©ration des rÃ©fÃ©rentiels depuis l\'API DAPLOS...');
$url = sprintf(
    '%s/referencials/?login=%s&apikey=%s',
    rtrim($config['api_url'], '/'),
    urlencode($config['api_login']),
    urlencode($config['api_key'])
);

$response = @file_get_contents($url);

if ($response === false) {
    $output->writeln('<error>âŒ Erreur : Impossible de contacter l\'API DAPLOS</error>');
    exit(1);
}

$referentials = json_decode($response, true);

if (!is_array($referentials) || empty($referentials)) {
    $output->writeln('<error>âŒ Erreur : Aucun rÃ©fÃ©rentiel trouvÃ©</error>');
    exit(1);
}

$output->writeln(sprintf('<info>âœ… %d rÃ©fÃ©rentiels trouvÃ©s</info>', count($referentials)));

// Filtrer les rÃ©fÃ©rentiels exclus
$excludedData = null;
if ($excludeFile !== null && file_exists($excludeFile)) {
    $excludedData = json_decode(file_get_contents($excludeFile), true);
}

$originalCount = count($referentials);
$referentials = array_filter($referentials, function ($ref) use ($excludeIds, $excludedData) {
    // Exclure par ID
    if (in_array((int) $ref['id'], $excludeIds, true)) {
        return false;
    }

    // Exclure par nom si spÃ©cifiÃ© dans le fichier
    if (is_array($excludedData) && isset($excludedData['names']) && is_array($excludedData['names'])) {
        if (in_array($ref['name'], $excludedData['names'], true)) {
            return false;
        }
    }

    return true;
});

$excludedCount = $originalCount - count($referentials);
if ($excludedCount > 0) {
    $output->writeln(sprintf('<comment>â­ï¸  %d rÃ©fÃ©rentiel(s) exclu(s)</comment>', $excludedCount));
}

$output->writeln(sprintf('<info>ğŸ“¦ %d rÃ©fÃ©rentiel(s) Ã  gÃ©nÃ©rer</info>', count($referentials)));
$output->writeln('');

// CrÃ©er le rÃ©pertoire si nÃ©cessaire
if (!$dryRun && !is_dir($outputDir)) {
    mkdir($outputDir, 0755, true);
    $output->writeln(sprintf('<info>ğŸ“ RÃ©pertoire crÃ©Ã© : %s</info>', $outputDir));
}

// Fonctions helper
/**
 * Convertit une chaÃ®ne en CamelCase en prÃ©servant les sÃ©parateurs de mots.
 */
function toCamelCase(string $text): string
{
    // Nettoyer les accents
    $unwantedArray = [
        'Å ' => 'S', 'Å¡' => 's', 'Å½' => 'Z', 'Å¾' => 'z',
        'Ã€' => 'A', 'Ã' => 'A', 'Ã‚' => 'A', 'Ãƒ' => 'A', 'Ã„' => 'A', 'Ã…' => 'A', 'Ã†' => 'A',
        'Ã‡' => 'C', 'Ãˆ' => 'E', 'Ã‰' => 'E', 'ÃŠ' => 'E', 'Ã‹' => 'E',
        'ÃŒ' => 'I', 'Ã' => 'I', 'Ã' => 'I', 'Ã' => 'I', 'Ã‘' => 'N',
        'Ã’' => 'O', 'Ã“' => 'O', 'Ã”' => 'O', 'Ã•' => 'O', 'Ã–' => 'O', 'Ã˜' => 'O',
        'Ã™' => 'U', 'Ãš' => 'U', 'Ã›' => 'U', 'Ãœ' => 'U', 'Ã' => 'Y', 'Ã' => 'B', 'ÃŸ' => 'Ss',
        'Ã ' => 'a', 'Ã¡' => 'a', 'Ã¢' => 'a', 'Ã£' => 'a', 'Ã¤' => 'a', 'Ã¥' => 'a', 'Ã¦' => 'a',
        'Ã§' => 'c', 'Ã¨' => 'e', 'Ã©' => 'e', 'Ãª' => 'e', 'Ã«' => 'e',
        'Ã¬' => 'i', 'Ã­' => 'i', 'Ã®' => 'i', 'Ã¯' => 'i', 'Ã°' => 'o', 'Ã±' => 'n',
        'Ã²' => 'o', 'Ã³' => 'o', 'Ã´' => 'o', 'Ãµ' => 'o', 'Ã¶' => 'o', 'Ã¸' => 'o',
        'Ã¹' => 'u', 'Ãº' => 'u', 'Ã»' => 'u', 'Ã¼' => 'u', 'Ã½' => 'y', 'Ã¾' => 'b', 'Ã¿' => 'y'
    ];

    $text = strtr($text, $unwantedArray);

    // Diviser en mots par espaces, tirets, underscores et autres caractÃ¨res non alphanumÃ©riques
    $words = preg_split('/[\s\-_]+|[^a-zA-Z0-9]+/', $text, -1, PREG_SPLIT_NO_EMPTY);

    // Mettre en majuscule la premiÃ¨re lettre de chaque mot et concatÃ©ner
    $camelCase = '';
    foreach ($words as $word) {
        // Ne garder que les caractÃ¨res alphanumÃ©riques du mot
        $cleanWord = preg_replace('/[^a-zA-Z0-9]/', '', $word);
        if ('' !== $cleanWord) {
            $camelCase .= ucfirst(strtolower($cleanWord));
        }
    }

    return $camelCase;
}

function normalizeTraitName(string $name): string
{
    $qualifier = '';
    if (preg_match('/\(([^)]+)\)/', $name, $matches)) {
        $qualifier = $matches[1];
    }

    $mainName = preg_replace('/\s*\([^)]*\)/', '', $name);

    // Convertir en CamelCase
    $mainNameCamelCase = toCamelCase($mainName);
    $qualifierCamelCase = '' !== $qualifier ? toCamelCase($qualifier) : '';

    return $mainNameCamelCase . $qualifierCamelCase;
}

function generateTraitContent(array $ref): string
{
    $traitName = normalizeTraitName($ref['name']) . 'Trait';
    $propertyPrefix = lcfirst(normalizeTraitName($ref['name']));
    $capitalPrefix = ucfirst($propertyPrefix);

    return <<<PHPCODE
<?php

namespace YoanBernabeu\DaplosBundle\Entity\Trait;

use Doctrine\ORM\Mapping as ORM;
use YoanBernabeu\DaplosBundle\Attribute\DaplosId;

/**
 * Trait pour le rÃ©fÃ©rentiel "{$ref['name']}".
 *
 * Repository Code: {$ref['repository_code']}
 * RÃ©fÃ©rentiel ID: {$ref['id']}
 * Nombre d'items: {$ref['count']}
 *
 * Ce trait permet d'associer une entitÃ© avec les donnÃ©es du rÃ©fÃ©rentiel DAPLOS.
 *
 * Pour utiliser ce trait avec le mapping automatique, ajoutez l'attribut #[DaplosId]
 * sur la propriÃ©tÃ© {$propertyPrefix}Id :
 *
 * use YoanBernabeu\DaplosBundle\Attribute\DaplosId;
 *
 * #[DaplosId]
 * private ?int \${$propertyPrefix}Id = null;
 */
trait {$traitName}
{
    #[DaplosId]
    #[ORM\Column(type: 'integer', nullable: true)]
    private ?int \${$propertyPrefix}Id = null;

    #[ORM\Column(type: 'string', length: 255, nullable: true)]
    private ?string \${$propertyPrefix}Title = null;

    #[ORM\Column(type: 'string', length: 50, nullable: true)]
    private ?string \${$propertyPrefix}ReferenceCode = null;

    public function get{$capitalPrefix}Id(): ?int
    {
        return \$this->{$propertyPrefix}Id;
    }

    public function set{$capitalPrefix}Id(?int \${$propertyPrefix}Id): self
    {
        \$this->{$propertyPrefix}Id = \${$propertyPrefix}Id;

        return \$this;
    }

    public function get{$capitalPrefix}Title(): ?string
    {
        return \$this->{$propertyPrefix}Title;
    }

    public function set{$capitalPrefix}Title(?string \${$propertyPrefix}Title): self
    {
        \$this->{$propertyPrefix}Title = \${$propertyPrefix}Title;

        return \$this;
    }

    public function get{$capitalPrefix}ReferenceCode(): ?string
    {
        return \$this->{$propertyPrefix}ReferenceCode;
    }

    public function set{$capitalPrefix}ReferenceCode(?string \${$propertyPrefix}ReferenceCode): self
    {
        \$this->{$propertyPrefix}ReferenceCode = \${$propertyPrefix}ReferenceCode;

        return \$this;
    }
}

PHPCODE;
}

// GÃ©nÃ©rer les traits
$output->writeln('ğŸ”¨ GÃ©nÃ©ration des traits...');
$progressBar = new ProgressBar($output, count($referentials));
$progressBar->start();

$generated = [];

foreach ($referentials as $ref) {
    $traitName = normalizeTraitName($ref['name']) . 'Trait';
    $fileName = $traitName . '.php';
    $filePath = $outputDir . '/' . $fileName;

    if (!$dryRun) {
        file_put_contents($filePath, generateTraitContent($ref));
    }

    $generated[] = [
        'trait' => $traitName,
        'file' => $fileName,
        'referential' => $ref['name'],
        'id' => $ref['id'],
        'repository_code' => $ref['repository_code']
    ];

    $progressBar->advance();
}

$progressBar->finish();
$output->writeln('');
$output->writeln('');

// GÃ©nÃ©rer l'index
if (!$dryRun) {
    $indexPath = dirname($outputDir) . '/TRAITS_INDEX.md';
    $indexContent = "# Index des Traits DAPLOS\n\n";
    $indexContent .= "| Trait | RÃ©fÃ©rentiel | ID | Repository Code |\n";
    $indexContent .= "|-------|-------------|----|-----------------|\n";

    foreach ($generated as $item) {
        $indexContent .= sprintf(
            "| %s | %s | %d | %s |\n",
            $item['trait'],
            $item['referential'],
            $item['id'],
            $item['repository_code']
        );
    }

    file_put_contents($indexPath, $indexContent);
    $output->writeln(sprintf('<info>ğŸ“„ Index gÃ©nÃ©rÃ© : %s</info>', $indexPath));
}

// RÃ©sumÃ©
$output->writeln('');
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln(sprintf(
    '<info>  âœ… %d traits %s avec succÃ¨s</info>',
    count($generated),
    $dryRun ? 'seraient gÃ©nÃ©rÃ©s' : 'gÃ©nÃ©rÃ©s'
));
$output->writeln('<info>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</info>');
$output->writeln('');

if (!$dryRun) {
    $output->writeln('ğŸ“ Prochaines Ã©tapes :');
    $output->writeln('  1. VÃ©rifier les traits gÃ©nÃ©rÃ©s');
    $output->writeln('  2. Commit les changements : git add src/Entity/Trait/');
    $output->writeln('  3. git commit -m "RÃ©gÃ©nÃ©ration des traits DAPLOS"');
}

$output->writeln('');
exit(0);

